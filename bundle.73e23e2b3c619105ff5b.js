(()=>{"use strict";let t=(t=21)=>{let e="",r=crypto.getRandomValues(new Uint8Array(t|=0));for(;t--;)e+="useandom-26T198340PX75pxJACKVERYMINDBUSHWOLF_GQZbfghjklqvwyzrict"[63&r[t]];return e};const e=(new class{get(){return this.log.bind(this)}getFormattedTimestamp(){const t=new Date;return`[${String(t.getDate()).padStart(2,"0")}.${String(t.getMonth()+1).padStart(2,"0")}.${String(t.getFullYear()).slice(-2)} ${String(t.getHours()).padStart(2,"0")}:${String(t.getMinutes()).padStart(2,"0")}:${String(t.getSeconds()).padStart(2,"0")}.${String(t.getMilliseconds()).padStart(3,"0")}]`}log(t,e){const r=`${this.getFormattedTimestamp()} [${e}] ${t}`;return console.log(r),r}}).get(),r="storage",n="trollo-board";function a(t){localStorage.setItem(n,JSON.stringify(t)),e(`saveBoard(${t})`,r)}const d="TrolloLord";const s=document.getElementById("board-placeholder");e("START","app"),new class{constructor(t){this.container=t,this.state=function(){const t=localStorage.getItem(n);return e(`loadBoard(): ${t}`,r),t?JSON.parse(t):null}()||this._getInitialState()}init(){this._renderBoard()}_getInitialState(){return{columns:[{id:"todo",title:"TODO",cards:[]},{id:"in-progress",title:"IN PROGRESS",cards:[]},{id:"done",title:"DONE",cards:[]}]}}_renderBoard(){const t=document.createElement("div");t.className="board",this.state.columns.forEach((e=>{const r=document.createElement("div");r.className="column",r.dataset.columnId=e.id;const n=document.createElement("h2");n.textContent=e.title,r.append(n);const a=document.createElement("div");a.className="column__list",e.cards.forEach((t=>{const e=this._createCardElement(t);a.append(e)})),r.append(a);const d=document.createElement("button");d.className="column__add",d.textContent="+ Add another card",d.dataset.columnId=e.id,r.append(d),t.append(r)})),this.container.replaceWith(t),this.container=t,this._bindEvents()}_createCardElement({id:t,text:e}){const r=document.createElement("div");r.className="card",r.draggable=!0,r.dataset.cardId=t,r.textContent=e;const n=document.createElement("button");return n.className="card__remove",n.textContent="×",n.title="Удалить карточку",r.append(n),r.addEventListener("mouseenter",(()=>{n.classList.add("visible")})),r.addEventListener("mouseleave",(()=>{n.classList.remove("visible")})),r}_bindEvents(){this.container.addEventListener("click",(t=>{e(`click: e.target=${t.target.tagName}`,d);const r=t.target.closest(".column__add");if(r){const t=r.dataset.columnId,e=prompt("Текст новой карточки:");return void(e&&this.addCard(t,e))}const n=t.target.closest(".card__remove");n&&(e(`remove: cardId=${n.closest(".card").dataset.cardId}`,d),this.removeCard(n.closest(".card").dataset.cardId))})),this._bindDragAndDrop()}_bindDragAndDrop(){let t,e,r=null;this.container.addEventListener("dragstart",(e=>{if(!(e.target instanceof HTMLElement))return;const n=e.target.closest(".card");n&&(r=n.dataset.cardId,t=n,n.classList.add("dragging"),document.body.style.cursor="grabbing",setTimeout((()=>{n.style.visibility="hidden"}),0))})),this.container.addEventListener("dragend",(n=>{n.target instanceof HTMLElement&&(t&&(t.classList.remove("dragging"),t.style.visibility=""),e&&e.parentNode&&e.parentNode.removeChild(e),document.body.style.cursor="",r=null)})),this.container.addEventListener("dragover",(r=>{if(r.preventDefault(),!(r.target instanceof HTMLElement))return;const n=r.target.closest(".column__list");if(!n)return;if(!e){e=document.createElement("div"),e.className="placeholder";const{width:r,height:n}=t.getBoundingClientRect();e.style.width=`${r}px`,e.style.height=`${n}px`,e.style.visibility="hidden"}n.querySelectorAll(".placeholder").forEach((t=>t.remove()));const a=Array.from(n.querySelectorAll(".card:not(.dragging)"));if(0===a.length)n.appendChild(e);else{let t=null,d=1/0;a.forEach((e=>{const{top:n,height:a}=e.getBoundingClientRect(),s=n+a/2,o=Math.abs(r.clientY-s);o<d&&(d=o,t=e)}));const{top:s,height:o}=t.getBoundingClientRect();r.clientY<s+o/2?n.insertBefore(e,t):n.insertBefore(e,t.nextSibling)}document.body.style.cursor="grabbing"})),this.container.addEventListener("drop",(t=>{if(t.preventDefault(),!e||!r)return;const n=this._extractCardById(r);e.parentNode.insertBefore(n,e),e.remove(),this._rebuildStateFromDOM(),a(this.state),this._renderBoard(),document.body.style.cursor="",r=null}))}_extractCardById(t){const e=this.container.querySelector(`.card[data-card-id="${t}"]`);return e&&e.parentNode.removeChild(e)}_rebuildStateFromDOM(){this.state.columns=Array.from(this.container.querySelectorAll(".column")).map((t=>({id:t.dataset.columnId,title:t.querySelector("h2").textContent,cards:Array.from(t.querySelectorAll(".card")).map((t=>({id:t.dataset.cardId,text:t.textContent.replace("×","").trim()})))})))}addCard(e,r){this.state.columns.find((t=>t.id===e)).cards.push({id:t(),text:r}),a(this.state),this._renderBoard()}removeCard(t){this.state.columns.forEach((e=>{const r=e.cards.findIndex((e=>e.id===t));-1!==r&&e.cards.splice(r,1)})),a(this.state),this._renderBoard()}}(s).init(),e("FINISH","app")})();